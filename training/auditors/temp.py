from auditors.audit_medcalc import AuditMedcalcRulesLooseJson
from auditors.audit_medcalc import AuditMedcalcFormula

import audit
import re

lines =  "<think>\n<partial_program>\n@traced\ndef analyze_input(input_str: str) -> tuple[str, list[str], list[str]]:\n    \"\"\"Accepts an input and extracts the question being asked, a list of the rules to follow to answer the question, and the patient note.\n\n    The question is the specific part of the input that needs to be answered.\n    The rules are the guidelines to answer the question.\n    The patient note contains the patient information.\n    \"\"\"\n    ...\n\n\n\n@traced\ndef get_data(rule: str, patient_note: list[str]) -> str:\n    \"\"\"Takes a rule and patient information and extracts the data from the patient note required to evaluate the rule.\n\n    Returns a string summarising this data.\n    \"\"\"\n    ...\n\n\n\n@traced\ndef eval_rule(rule: str, data: str) -> int:\n    \"\"\"Takes a rule and the data relevant to that rule, and returns the value specified by the rule.\n\n    \"\"\"\n\n\n@traced\ndef sum_rules(rule_scores: list[int]) -> int:\n    \"\"\"Takes a list of scores and returns their sum.\"\"\"\n    ...\n\n\n\n</partial_program>\n\n<program_trace>\nCalling analyze_input(\"A 60-year-old male with a history of liver failure and immunocompromise presents to the emergency department with acute symptoms of lethargy and decreased appetite. Physical examination reveals tachycardia to 95 beats per minute, respiratory rate of 19 breaths per minute, blood pressure registering at 135/75 mm Hg and a baseline temperature of 37.2\u00b0C. Neurological assessment demonstrates mild confusion, corresponding to a Glasgow Coma Score of 14. Blood tests reveal elevated creatinine levels at 3.8 mg/dL. Metabolic panel showed sodium at 138 and potassium at 4.5 mEq/L. The white blood cell count was 12,000 per \u00b5L, triggering concern for a possible infection. Hematocrit was just within normal range at 43 %. The patient had an arterial blood gas pH of 7.32 and a A-a-gradient of 364, with a supplementary FiO\u2082 of 55 %. This patient's acute renal failure symptomatology, alongside the history of severe organ failure and immunocompromised, mandate rigorous monitoring and urgent medical intervention.\\n\\nWhat is the patient's APACHE II score?\\n\\nCalculate APACHE II Score by summing the results of the following rules:\\n    Age, years: \u226444 = 0 points, 45-54 = +2 points, 55-64 = +3 points, 65-74 = +5 points, \u226575 = +6 points\\n    History of severe organ insufficiency or immunocompromised: Yes, nonoperative or emergency postoperative patient = +5 points, Yes, elective postoperative patient = +2 points, No = 0 points\\n    History of severe organ insufficiency or immunocompromised: Yes, nonoperative or emergency postoperative patient = +5 points, Yes, elective postoperative patient = +2 points, No = 0 points\\n    Rectal temperature, \u00b0C: \u226541 = +4 points, 39 to <41 = +3 points, 38.5 to <39 = +1 point, 36 to <38.5 = 0 points, 34 to <36 = +1 point, 32 to <34 = +2 points, 30 to <32 = +3 points, <30 = +4 points\\n    Mean arterial pressure, mmHg: \u2265160 = +4 points, 130-159 = +3 points, 110-129 = +2 points, 70-109 = 0 points, 50-69 = +2 points, 40-49 = +3 points, <40 = +4 points\\n    Heart rate, beats per minute: \u2265180 = +4 points, 140 to <180 = +3 points, 110 to <140 = +2 points, 70 to <110 = 0 points, 55 to <70 = +2 points, 40 to <55 = +3 points, <40 = +4 points\\n    Respiratory rate, breaths per minute: \u226550 = +4 points, 35 to <50 = +3 points, 25 to <35 = +1 point, 12 to <25 = 0 points, 10 to <12 = +1 point, 6 to <10 = +2 points, <6 = +4 points\\n    Oxygenation (use PaO2 if FiO2 <50%, otherwise use Aa gradient): Aa gradient >349 = +4 points, Aa gradient 350-349 = +3 points, Aa gradient 200-349 = +2 points, Aa gradient <200 (if FiO2 over 45%) or PaO2 <70 (if FiO2 less than 50%) = +1 point, PaO2 61-70 = +1 point, PaO2 55-60 = +3 points, PaO2 <55 = +4 points\\n    Arterial pH: \u22657.7 = +4 points, 7.60 to <7.70 = +3 points, 7.50 to <7.60 = +1 point, 7.33 to <7.50 = 0 points, 7.25 to <7.33 = +2 points, 7.15 to <7.25 = +3 points, <7.15 = +4 points\\n    Serum sodium, mmol/L: \u2265180 = +4 points, 160 to <180 = +3 points, 155 to <160 = +2 points, 150 to <155 = +1 point, 130 to <150 = 0 points, 120 to <130 = +2 points, 111 to <120 = +3 points, <111 = +4 points\\n    Serum potassium, mmol/L: \u22657.0 = +4 points, 6.0 to <7.0 = +3 points, 5.5 to <6.0 = +1 point, 3.5 to <5.5 = 0 points, 3.0 to <3.5 = +1 point, 2.5 to <3.0 = +2 points, <2.5 = +4 points\\n    Serum creatinine, mg/100 mL: \u22653.5 and ACUTE renal failure = +8 points, 2.0 to <3.5 and ACUTE renal failure = +6 points, \u22653.5 and CHRONIC renal failure = +4 points, 1.5 to <2.0 and ACUTE renal failure = +4 points, 2.0 to <3.5 and CHRONIC renal failure = +3 points, 1.5 to <2.0 and CHRONIC renal failure = +2 points, 0.6 to <1.5 = 0 points, <0.6 = +2 points\\n    Hematocrit, %: \u226560 = +4 points, 50 to <60 = +2 points, 46 to <50 = +1 point, 30 to <46 = 0 points, 20 to <30 = +2 points, <20 = +4 points\\n    White blood count, total/cubic mm in 10^3: \u226540 = +4 points, 20 to <40 = +2 points, 15 to <20 = +1 point, 3 to <15 = 0 points, 1 to <3 = +2 points, <1 = +4 points\\n    Glasgow Coma Scale (GCS): 1-15 points (use 15 - [GCS Score]))\")...\n...analyze_input returned (\"What is the patient's APACHE II score?\", ['Age, years: \u226444 = 0 points, 45-54 = +2 points, 55-64 = +3 points, 65-74 = +5 points, \u226575 = +6 points', 'History of severe organ insufficiency or immunocompromised: Yes, nonoperative or emergency postoperative patient = +5 points, Yes, elective postoperative patient = +2 points, No = 0 points', 'Rectal temperature, \u00b0C: \u226541 = +4 points, 39 to <41 = +3 points, 38.5 to <39 = +1 point, 36 to <38.5 = 0 points, 34 to <36 = +1 point, 32 to <34 = +2 points, 30 to <32 = +3 points, <30 = +4 points', 'Mean arterial pressure, mmHg: \u2265160 = +4 points, 130-159 = +3 points, 110-129 = +2 points, 70-109 = 0 points, 50-69 = +2 points, 40-49 = +3 points, <40 = +4 points', 'Heart rate, beats per minute: \u2265180 = +4 points, 140 to <180 = +3 points, 110 to <140 = +2 points, 70 to <110 = 0 points, 55 to <70 = +2 points, 40 to <55 = +3 points, <40 = +4 points', 'Respiratory rate, breaths per minute: \u226550 = +4 points, 35 to <50 = +3 points, 25 to <35 = +1 point, 12 to <25 = 0 points, 10 to <12 = +1 point, 6 to <10 = +2 points, <6 = +4 points', 'Oxygenation (use PaO2 if FiO2 <50%, otherwise use Aa gradient): Aa gradient >349 = +4 points, Aa gradient 350-349 = +3 points, Aa gradient 200-349 = +2 points, Aa gradient <200 (if FiO2 over 45%) or PaO2 <70 (if FiO2 less than 50%) = +1 point, PaO2 61-70 = +1 point, PaO2 55-60 = +3 points, PaO2 <55 = +4 points', 'Arterial pH: \u22657.7 = +4 points, 7.60 to <7.70 = +3 points, 7.50 to <7.60 = +1 point, 7.33 to <7.50 = 0 points, 7.25 to <7.33 = +2 points, 7.15 to <7.25 = +3 points, <7.15 = +4 points', 'Serum sodium, mmol/L: \u2265180 = +4 points, 160 to <180 = +3 points, 155 to <160 = +2 points, 150 to <155 = +1 point, 130 to <150 = 0 points, 120 to <130 = +2 points, 111 to <120 = +3 points, <111 = +4 points', 'Serum creatinine, mg/100 mL: \u22653.5 and ACUTE renal failure = +8 points', 'Glasgow Coma Scale (GCS): 1-15 points (use 15 - [GCS Score])'], '60-year-old male with liver failure and immunocompromise, temp 37.2\u00b0C, HR 95, BP 135/75, GCS 14, creatinine 3.8 mg/dL, sodium 138, potassium 4.5, WBC 12,000')\nCalling get_data('Age, years: \u226444 = 0 points, 45-54 = +2 points, 55-64 = +3 points, 65-74 = +5 points, \u226575 = +6 points', ['60 years old'])...\n...get_data returned '60 years old'\nCalling eval_rule('Age, years: \u226444 = 0 points, 45-54 = +2 points, 55-64 = +3 points, 65-74 = +5 points, \u226575 = +6 points', '60 years old')...\n...eval_rule returned 3\nCalling get_data('History of severe organ insufficiency or immunocompromised: Yes, nonoperative or emergency postoperative patient = +5 points, Yes, elective postoperative patient = +2 points, No = 0 points', ['history of liver failure and immunocompromise'])...\n...get_data returned 'history of liver failure and immunocompromise'\nCalling eval_rule('History of severe organ insufficiency or immunocompromised: Yes, nonoperative or emergency postoperative patient = +5 points, Yes, elective postoperative patient = +2 points, No = 0 points', 'history of liver failure and immunocompromise')...\n...eval_rule returned 5\nCalling get_data('Rectal temperature, \u00b0C: \u226541 = +4 points, 39 to <41 = +3 points, 38.5 to <39 = +1 point, 36 to <38.5 = 0 points, 34 to <36 = +1 point, 32 to <34 = +2 points, 30 to <32 = +3 points, <30 = +4 points', '37.2\u00b0C')...\n...get_data returned '37.2\u00b0C'\nCalling eval_rule('Rectal temperature, \u00b0C: \u226541 = +4 points, 39 to <41 = +3 points, 38.5 to <39 = +1 point, 36 to <38.5 = 0 points, 34 to <36 = +1 point, 32 to <34 = +2 points, 30 to <32 = +3 points, <30 = +4 points', '37.2\u00b0C')...\n...eval_rule returned 0\nCalling get_data('Mean arterial pressure, mmHg: \u2265160 = +4 points, 130-159 = +3 points, 110-129 = +2 points, 70-109 = 0 points, 50-69 = +2 points, 40-49 = +3 points, <40 = +4 points', '135/75 mm Hg')...\n...get_data returned 'mean arterial pressure = 95.6 mm Hg'\nCalling eval_rule('Mean arterial pressure, mmHg: \u2265160 = +4 points, 130-159 = +3 points, 110-129 = +2 points, 70-109 = 0 points, 50-69 = +2 points, 40-49 = +3 points, <40 = +4 points', '95.6 mm Hg')...\n...eval_rule returned 0\nCalling get_data('Heart rate, beats per minute: \u2265180 = +4 points, 140 to <180 = +3 points, 110 to <140 = +2 points, 70 to <110 = 0 points, 55 to <70 = +2 points, 40 to <55 = +3 points, <40 = +4 points', 'HR 95')...\n...get_data returned 'HR 95'\nCalling eval_rule('Heart rate, beats per minute: \u2265180 = +4 points, 140 to <180 = +3 points, 110 to <140 = +2 points, 70 to <110 = 0 points, 55 to <70 = +2 points, 40 to <55 = +3 points, <40 = +4 points', 'HR 95')...\n...eval_rule returned 2\nCalling get_data('Respiratory rate, breaths per minute: \u226550 = +4 points, 35 to <50 = +3 points, 25 to <35 = +1 point, 12 to <25 = 0 points, 10 to <12 = +1 point, 6 to <10 = +2 points, <6 = +4 points', 'respiratory rate of 19 breaths per minute')...\n...get_data returned 'respiratory rate of 19 breaths per minute'\nCalling eval_rule('Respiratory rate, breaths per minute: \u226550 = +4 points, 35 to <50 = +3 points, 25 to <35 = +1 point, 12 to <25 = 0 points, 10 to <12 = +1 point, 6 to <10 = +2 points, <6 = +4 points', 'respiratory rate of 19 breaths per minute')...\n...eval_rule returned 0\nCalling get_data('Oxygenation (use PaO2 if FiO2 <50%, otherwise use Aa gradient): Aa gradient >349 = +4 points, Aa gradient 350-349 = +3 points, Aa gradient 200-349 = +2 points, Aa gradient <200 (if FiO2 over 45%) or PaO2 <70 (if FiO2 less than 50%) = +1 point, PaO2 61-70 = +1 point, PaO2 55-60 = +3 points, PaO2 <55 = +4 points', 'A-a-gradient of 364, FiO\u2082 of 55 %')...\n...get_data returned 'A-a-gradient of 364'\nCalling eval_rule('Oxygenation (use PaO2 if FiO2 <50%, otherwise use Aa gradient): Aa gradient >349 = +4 points, Aa gradient 350-349 = +3 points, Aa gradient 200-349 = +2 points, Aa gradient <200 (if FiO2 over 45%) or PaO2 <70 (if FiO2 less than 50%) = +1 point, PaO2 61-70 = +1 point, PaO2 55-60 = +3 points, PaO2 <55 = +4 points', 'A-a-gradient of 364')...\n...eval_rule returned 4\nCalling get_data('Arterial pH: \u22657.7 = +4 points, 7.60 to <7.70 = +3 points, 7.50 to <7.60 = +1 point, 7.33 to <7.50 = 0 points, 7.25 to <7.33 = +2 points, 7.15 to <7.25 = +3 points, <7.15 = +4 points', 'pH of 7.32')...\n...get_data returned 'pH of 7.32'\nCalling eval_rule('Arterial pH: \u22657.7 = +4 points, 7.60 to <7.70 = +3 points, 7.50 to <7.60 = +1 point, 7.33 to <7.50 = 0 points, 7.25 to <7.33 = +2 points, 7.15 to <7.25 = +3 points, <7.15 = +4 points', 'pH of 7.32')...\n...eval_rule returned 0\nCalling get_data('Serum sodium, mmol/L: \u2265180 = +4 points, 160 to <180 = +3 points, 155 to <160 = +2 points, 150 to <155 = +1 point, 130 to <150 = 0 points, 120 to <130 = +2 points, 111 to <120 = +3 points, <111 = +4 points', 'sodium 138')...\n...get_data returned 'sodium 138'\nCalling eval_rule('Serum sodium, mmol/L: \u2265180 = +4 points, 160 to <180 = +3 points, 155 to <160 = +2 points, 150 to <155 = +1 point, 130 to <150 = 0 points, 120 to <130 = +2 points, 111 to <120 = +3 points, <111 = +4 points', 'sodium 138')...\n...eval_rule returned 0\nCalling get_data('Serum creatinine, mg/100 mL: \u22653.5 and ACUTE renal failure = +8 points', 'creatinine 3.8 mg/dL')...\n...get_data returned 'creatinine 3.8 mg/dL'\nCalling eval_rule('Serum creatinine, mg/100 mL: \u22653.5 and ACUTE renal failure = +8 points', 'creatinine 3.8 mg/dL')...\n...eval_rule returned 8\nCalling get_data('Glasgow Coma Scale (GCS): 1-15 points (use 15 - [GCS Score])', 'GCS 14')...\n...get_data returned 'GCS 14'\nCalling eval_rule('Glasgow Coma Scale (GCS): 1-15 points (use 15 - [GCS Score])', 'GCS 14')...\n...eval_rule returned 1\nCalling sum_rules([3, 5, 0, 0, 2, 0, 4, 0, 8, 1])...\n...sum_rules returned 20\n</program_trace>\n</think>\n<answer>\n20\n</answer>"
trace_pattern = r'<program_trace>\n(.*?)\n</program_trace>'
traces = re.findall(trace_pattern, lines, re.DOTALL)
lines = traces[0].split('\n')

a = AuditMedcalcRulesLooseJson(audit.Trace(lines))
a.run_audits()
print(a.audits)

t = audit.Trace(lines)
print('all errors:')
print(t.errors)
a = AuditMedcalcRulesLooseJson(t)
a.run_audits()
print('all audits:')
print(a.audits)

print('=='*20)

from typicality import SkeletonLogProb
import json

with open('auditors/scores/rules2.json', 'r') as f:
    loaded_dict = json.load(f)


model = SkeletonLogProb.from_dict(loaded_dict)
score = model.predict_score(lines) 
print(score)
good = model.is_score_above_median(lines)
print(good)


def evaluate_single_trace(trace):
    pass